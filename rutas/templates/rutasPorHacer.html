{% extends 'base.html' %}
{% block title %}Rutas por hacer{% endblock %}
{% block content %}

<h2 class="mb-4">
    {% if entrega_a_editar %}
        Editar entrega de {{ entrega_a_editar.cliente }}
    {% else %}
        Rutas por hacer
    {% endif %}
</h2>
<hr>

<form method="post">
    {% csrf_token %}
    {% if entrega_a_editar %}
        <input type="hidden" name="id_entrega" value="{{ entrega_a_editar.id_entrega }}">
    {% endif %}

    <div class="row mb-3">
        <div class="col-md-6">{{ form.nombre_cliente.label_tag }}{{ form.nombre_cliente }}</div>
        <div class="col-md-6">{{ form.telefono.label_tag }}{{ form.telefono }}</div>
    </div>

    <label class="form-label"><strong>Dirección del cliente</strong></label>
    <div class="row mb-3">
        <div class="col-md-6">{{ form.calle.label_tag }}{{ form.calle }}</div>
        <div class="col-md-3">{{ form.num_int.label_tag }}{{ form.num_int }}</div>
        <div class="col-md-3">{{ form.num_ext.label_tag }}{{ form.num_ext }}</div>
    </div>

    <div class="row mb-3">
        <div class="col-md-6">{{ form.colonia.label_tag }}{{ form.colonia }}</div>
        <div class="col-md-6">{{ form.municipio.label_tag }}{{ form.municipio }}</div>
    </div>

    <div class="row mb-3">
        <div class="col-md-6">{{ form.cp.label_tag }}{{ form.cp }}</div>
        <div class="col-md-6">{{ form.tipo_entrega.label_tag }}{{ form.tipo_entrega }}</div>
    </div>

    <label class="form-label"><strong>Información del beneficio</strong></label>
    <div class="row mb-3">
        <div class="col-md-8">{{ form.beneficio.label_tag }}{{ form.beneficio }}</div>
        <div class="col-md-4">
            {{ form.monto.label_tag }}
            <div class="input-group">
                <span class="input-group-text">$</span>
                {{ form.monto }}
            </div>
        </div>
    </div>

    <div class="d-flex justify-content-between">
        {% if entrega_a_editar %}
            <button type="submit" name="accion" value="editar" class="btn btn-success">Guardar cambios</button>
            <a href="{% url 'rutas' %}" class="btn btn-secondary">Cancelar edición</a>
        {% else %}
            <button type="submit" name="accion" value="agregar" class="btn btn-success">Agregar ruta</button>
            <button type="submit" name="accion" value="generar" class="btn btn-success">Generar ruta</button>
        {% endif %}
    </div>
</form>

<hr>

<h2 class="mb-4">Entregas registradas</h2>

<div style="max-height: 600px; overflow-y: auto; border: 1px solid #ccc; padding: 15px; border-radius: 8px;">
    {% for entrega in entregas_reagendadas %}
    <div class="mb-3 p-3 border rounded bg-light d-flex justify-content-between align-items-center">
        <div>
            <strong>Cliente:</strong> {{ entrega.cliente }}<br>
            <strong>Tipo de entrega:</strong> {{ entrega.tipo_entrega }}
        </div>
        <div class="d-flex">
            <!-- Botón Editar -->
            <form method="post" action="{% url 'rutas' %}">
                {% csrf_token %}
                <input type="hidden" name="editar_id" value="{{ entrega.id_entrega }}">
                <button type="submit" class="btn btn-primary me-2">Editar</button>
            </form>

            <!-- Botón Eliminar -->
            <form method="post" action="{% url 'eliminar_entrega' entrega.id_entrega %}">
                {% csrf_token %}
                <button type="submit" class="btn btn-danger">Eliminar</button>
            </form>
        </div>
    </div>
    {% empty %}
    <p>No hay entregas creadas.</p>
    {% endfor %}
</div>

<!-- Validación personalizada en español -->
<script>
document.addEventListener("DOMContentLoaded", function() {
  const mensajes = {
    nombre_cliente: "Por favor, ingresa el nombre del cliente.",
    telefono: "Por favor, ingresa el teléfono del cliente.",
    calle: "Por favor, ingresa la calle.",
    colonia: "Por favor, ingresa la colonia.",
    municipio: "Por favor, ingresa el municipio o delegación.",
    cp: "Por favor, ingresa el código postal.",
    tipo_entrega: "Por favor, selecciona el tipo de entrega.",
    beneficio: "Por favor, describe el beneficio.",
    monto: "Por favor, ingresa el monto del beneficio."
  };

  Object.entries(mensajes).forEach(([name, mensaje]) => {
    const campo = document.querySelector(`[name="${name}"]`);
    if (campo) {
      campo.oninvalid = function() {
        this.setCustomValidity(mensaje);
      };
      campo.oninput = function() {
        this.setCustomValidity("");
      };
    }
  });
});
</script>

{% endblock %}
